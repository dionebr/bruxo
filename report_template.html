<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bruxo Tactical Report - {{ .TargetURL }}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=Roboto:wght@400;500;700&display=swap');
        body { font-family: 'Roboto', sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 1600px; margin: auto; }
        header { text-align: center; margin-bottom: 20px; }
        header h1 { font-family: 'Fira Code', monospace; color: #9c27b0; }
        .dashboard {
            display: grid;
            grid-template-columns: 3fr 2fr 4fr;
            grid-template-rows: auto 1fr;
            gap: 20px;
            height: 80vh;
        }
        .panel {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            overflow-y: auto;
        }
        .panel-header { grid-column: 1 / -1; text-align: center; background-color: #1e1e1e; padding: 10px; border-radius: 8px;}
        #heatmap-panel h3, #attack-path-panel h3, #details-panel h3 { margin-top: 0; color: #9c27b0; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        /* Heatmap Styles */
        .heatmap-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .heat-card {
            background-color: #2a2a2a; border-radius: 5px; padding: 10px; text-align: center;
            cursor: pointer; transition: transform 0.2s; border-bottom: 4px solid;
            word-break: break-word; font-size: 0.9em;
        }
        .heat-card:hover { transform: scale(1.05); }
        .severity-Critical { border-color: #f44336; } /* Red */
        .severity-High { border-color: #FF9800; } /* Orange */
        .severity-Medium { border-color: #FFC107; } /* Amber */
        .severity-Low { border-color: #2196F3; } /* Blue */
        .severity-Informational { border-color: #4CAF50; } /* Green */
        .severity-None { border-color: #444; }

        /* Attack Path Styles */
        .attack-step { padding: 10px; margin-bottom: 10px; border-radius: 5px; background-color: #2a2a2a; cursor: pointer; border-left: 4px solid;}
        
        /* Details Panel Styles */
        #details-panel .detail-block { margin-bottom: 15px; }
        #details-panel h4 { color: #9c27b0; margin-bottom: 5px; }
        #details-panel p { margin: 5px 0; background-color: #2a2a2a; padding: 8px; border-radius: 4px; }
        #details-panel pre { background-color: #111; padding: 10px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; }

        /* Post-Exploitation Panel Styles */
        #post-exploitation-panel {
            grid-column: 1 / -1; /* Make it span the full width */
            border-top: 4px solid #f44336; /* Red border to indicate danger */
            margin-top: 20px;
        }
        .playbook-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .playbook-section h4 {
            color: #FF9800; /* Orange */
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }
        .playbook-section ul {
            list-style: none;
            padding: 0;
        }
        .playbook-section li {
            background-color: #2a2a2a;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 5px;
            font-family: 'Fira Code', monospace;
        }
        .playbook-section pre {
            background-color: #111;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Fira Code', monospace;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard">
            <div class="panel-header">
                 <h1>ðŸ§™ Bruxo Tactical Dashboard</h1>
                 <p>Target: <strong>{{ .TargetURL }}</strong></p>
            </div>

            <div id="heatmap-panel" class="panel">
                <h3>Vulnerability Heatmap</h3>
                <div id="heatmap-grid" class="heatmap-grid"></div>
            </div>

            <div id="attack-path-panel" class="panel">
                <h3>Critical Attack Path</h3>
                <div id="attack-path-list"></div>
            </div>

            <div id="details-panel" class="panel">
                <h3>Details</h3>
                <div id="details-content">Select an item from the Heatmap or Attack Path to see details.</div>
            </div>

            <div id="post-exploitation-panel" class="panel" style="display: none;">
                <h3>Post-Exploitation Playbook</h3>
                <div class="playbook-grid">
                    <div class="playbook-section">
                        <h4>Suggested Tools</h4>
                        <ul>
                            <li><strong>Metasploit:</strong> exploit/multi/handler</li>
                            <li><strong>Cobalt Strike:</strong> Beacon</li>
                            <li><strong>BloodHound:</strong> AD Mapping</li>
                        </ul>
                    </div>
                    <div class="playbook-section">
                        <h4>Recommended Commands</h4>
                        <pre><code>whoami /all
net user /domain
sekurlsa::logonpasswords</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const results = {{ .Results | json }};

        const severityOrder = { 'Critical': 1, 'High': 2, 'Medium': 3, 'Low': 4, 'Informational': 5, 'None': 6 };

        function getHighestSeverity(vulnerabilities) {
            if (!vulnerabilities || vulnerabilities.length === 0) return 'None';
            return vulnerabilities.reduce((max, v) => severityOrder[v.Severity] < severityOrder[max] ? v.Severity : max, 'None');
        }

        const heatmapGrid = document.getElementById('heatmap-grid');
        const attackPathList = document.getElementById('attack-path-list');
        const detailsContent = document.getElementById('details-content');

        // 1. Process and sort data
        const processedResults = results.map(r => ({...r, highestSeverity: getHighestSeverity(r.Vulnerabilities)}));
        processedResults.sort((a, b) => severityOrder[a.highestSeverity] - severityOrder[b.highestSeverity]);

        // 2. Populate Panels
        processedResults.forEach(result => {
            // Populate Heatmap
            const heatCard = document.createElement('div');
            heatCard.className = `heat-card severity-${result.highestSeverity}`;
            heatCard.textContent = result.URL.split('/').pop() || result.URL; // Show last part of URL
            heatCard.onclick = () => showDetails(result);
            heatmapGrid.appendChild(heatCard);

            // Populate Attack Path (only if vulnerabilities exist)
            if (result.Vulnerabilities && result.Vulnerabilities.length > 0) {
                const attackStep = document.createElement('div');
                attackStep.className = `attack-step severity-${result.highestSeverity}`;
                attackStep.innerHTML = `<strong>${result.highestSeverity}:</strong> ${result.Vulnerabilities[0].Name}`;
                attackStep.onclick = () => showDetails(result);
                attackPathList.appendChild(attackStep);
            }
        });

        // 3. Details Function
        function showDetails(result) {
            let vulnerabilitiesHTML = '<h4>No vulnerabilities detected.</h4>';
            if (result.Vulnerabilities && result.Vulnerabilities.length > 0) {
                vulnerabilitiesHTML = result.Vulnerabilities.map(v => `
                    <div class="detail-block">
                        <h4>${v.Name} (${v.Severity})</h4>
                        <p><strong>Description:</strong> ${v.Description}</p>
                        <p><strong>Recommendation:</strong> ${v.Recommendation}</p>
                    </div>
                `).join('');
            }

            detailsContent.innerHTML = `
                <h3>${result.URL}</h3>
                <div class="detail-block">
                    <p><strong>Status Code:</strong> ${result.StatusCode}</p>
                    <p><strong>Content-Length:</strong> ${result.ContentLength} bytes</p>
                </div>
                ${vulnerabilitiesHTML}
            `;
        }

        // 4. Post-Exploitation Panel Logic
        const hasHighOrCriticalVuln = processedResults.some(r => 
            r.highestSeverity === 'Critical' || r.highestSeverity === 'High'
        );

        if (hasHighOrCriticalVuln) {
            const postExploitationPanel = document.getElementById('post-exploitation-panel');
            if(postExploitationPanel) {
                postExploitationPanel.style.display = 'block';
            }
        }

    </script>
</body>
</html>
