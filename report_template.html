<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bruxo Tactical Report - {{ .TargetURL }}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=Roboto:wght@400;500;700&display=swap');
        body { font-family: 'Roboto', sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 1600px; margin: auto; }
        header { text-align: center; margin-bottom: 20px; }
        header h1 { font-family: 'Fira Code', monospace; color: #9c27b0; }
        .dashboard {
            display: grid;
            grid-template-columns: 3fr 2fr 4fr;
            grid-template-rows: auto 1fr;
            gap: 20px;
            height: 80vh;
        }
        .panel {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            overflow-y: auto;
        }
        .panel-header { grid-column: 1 / -1; text-align: center; background-color: #1e1e1e; padding: 10px; border-radius: 8px;}
        #heatmap-panel h3, #attack-path-panel h3, #details-panel h3 { margin-top: 0; color: #9c27b0; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        /* Heatmap Styles */
        .heatmap-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .heat-card {
            background-color: #2a2a2a; border-radius: 5px; padding: 10px; text-align: center;
            cursor: pointer; transition: transform 0.2s; border-bottom: 4px solid;
            word-break: break-word; font-size: 0.9em;
        }
        .heat-card:hover { transform: scale(1.05); }
        .severity-Critical { border-color: #f44336; } /* Red */
        .severity-High { border-color: #FF9800; } /* Orange */
        .severity-Medium { border-color: #FFC107; } /* Amber */
        .severity-Low { border-color: #2196F3; } /* Blue */
        .severity-Informational { border-color: #4CAF50; } /* Green */
        .severity-None { border-color: #444; }

        /* Attack Path Styles */
        .attack-step { padding: 10px; margin-bottom: 10px; border-radius: 5px; background-color: #2a2a2a; cursor: pointer; border-left: 4px solid;}
        
        /* Details Panel Styles */
        #details-panel .detail-block { margin-bottom: 15px; }
        #details-panel h4 { color: #9c27b0; margin-bottom: 5px; }
        #details-panel p { margin: 5px 0; background-color: #2a2a2a; padding: 8px; border-radius: 4px; }
        #details-panel pre { background-color: #111; padding: 10px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Fira Code', monospace; margin-top: 5px; }
        #details-panel h5 { color: #FF9800; margin-top: 15px; margin-bottom: 5px; }
        .attack-flow-steps { margin-top: 10px; border-left: 2px solid #9c27b0; padding-left: 10px; }
        .mitre-block { background-color: #2a2a2a; padding: 10px; border-radius: 4px; margin-top: 15px; border-left: 4px solid #f44336;}
        .mitre-block a { color: #9c27b0; text-decoration: none; }
        .attack-flow-step { display: flex; align-items: center; margin-bottom: 5px; }
        .attack-flow-step input[type='checkbox'] { margin-right: 10px; }



        /* Post-Exploitation Panel Styles */
        #post-exploitation-panel {
            grid-column: 1 / -1; /* Make it span the full width */
            border-top: 4px solid #f44336; /* Red border to indicate danger */
            margin-top: 20px;
        }
        .playbook-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .playbook-section h4 {
            color: #FF9800; /* Orange */
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }
        .playbook-section ul {
            list-style: none;
            padding: 0;
        }
        .playbook-section li {
            background-color: #2a2a2a;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 5px;
            font-family: 'Fira Code', monospace;
        }
        .playbook-section pre {
            background-color: #111;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Fira Code', monospace;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard">
            <div class="panel-header">
                 <h1>ðŸ§™ Bruxo Tactical Dashboard</h1>
                 <p>Target: <strong>{{ .TargetURL }}</strong></p>
            </div>

            <div id="heatmap-panel" class="panel">
                <h3>Vulnerability Heatmap</h3>
                <div id="heatmap-grid" class="heatmap-grid"></div>
            </div>

            <div id="attack-path-panel" class="panel">
                <h3>Critical Attack Path</h3>
                <div id="attack-path-list"></div>
            </div>

            <div id="details-panel" class="panel">
                <h3>Details</h3>
                <div id="details-content">Select an item from the Heatmap or Attack Path to see details.</div>
            </div>
        </div>

        <!-- SeÃ§Ã£o de CenÃ¡rios de Ataque -->
        {{if .AttackScenarios}}
        <div class="panel" style="grid-column: 1 / -1; margin-top: 20px;">
            <h3 style="color: #f44336;">Attack Scenarios</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {{range .AttackScenarios}}
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg" style="background-color: #2a2a2a;">
                    <h4 class="text-xl font-bold text-yellow-400 mb-3" style="color: #FFC107;">{{.Objective}}</h4>
                    <div class="mb-3">
                        <p class="font-semibold text-gray-300">Steps:</p>
                        <ul class="list-disc list-inside text-gray-400" style="padding-left: 20px;">
                            {{range .Steps}}
                            <li>{{.}}</li>
                            {{end}}
                        </ul>
                    </div>
                    <div class="flex justify-between text-sm" style="display: flex; justify-content: space-between;">
                        <p class="text-gray-400"><span class="font-bold text-gray-300">Est. Time:</span> {{.EstimatedTime}}</p>
                        <p class="text-red-400"><span class="font-bold text-red-300">Success:</span> {{.SuccessProbability}}</p>
                    </div>
                </div>
                {{end}}
            </div>
        </div>
        {{end}}

        <!-- SeÃ§Ã£o C2 -->
        <div class="panel" style="grid-column: 1 / -1; margin-top: 20px;">
            <h3 style="color: #4CAF50;">C2 Agents</h3>
            <table id="c2-agents-table" style="width: 100%; text-align: left; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid #444;">
                        <th style="padding: 8px;">ID</th>
                        <th style="padding: 8px;">IP Address</th>
                        <th style="padding: 8px;">Hostname</th>
                        <th style="padding: 8px;">OS</th>
                        <th style="padding: 8px;">Last Seen</th>
                        <th style="padding: 8px;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Agentes serÃ£o inseridos aqui -->
                </tbody>
            </table>
        </div>

        <!-- Modal do Terminal C2 -->
        <div id="c2-terminal-modal" style="display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);">
            <div style="background-color: #1e1e1e; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 8px; font-family: 'Fira Code', monospace;">
                <h4 id="terminal-title" style="color: #9c27b0;">Terminal for Agent: </h4>
                <div id="terminal-output" style="height: 300px; background-color: #111; overflow-y: scroll; padding: 10px; border-radius: 4px; margin-bottom: 10px; white-space: pre-wrap;"></div>
                <input type="text" id="terminal-input" style="width: calc(100% - 20px); background-color: #2a2a2a; color: #e0e0e0; border: 1px solid #444; padding: 10px; border-radius: 4px;" placeholder="Enter command...">
                <button onclick="closeTerminal()" style="float: right;">Close</button>
            </div>
        </div>

        <div id="post-exploitation-panel" class="panel" style="display: none;">
                <h3>Post-Exploitation Playbook</h3>
                <div class="playbook-grid">
                    <div class="playbook-section">
                        <h4>Suggested Tools</h4>
                        <ul>
                            <li><strong>Metasploit:</strong> exploit/multi/handler</li>
                            <li><strong>Cobalt Strike:</strong> Beacon</li>
                            <li><strong>BloodHound:</strong> AD Mapping</li>
                        </ul>
                    </div>
                    <div class="playbook-section">
                        <h4>Recommended Commands</h4>
                        <pre><code>whoami /all
net user /domain
sekurlsa::logonpasswords</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const results = JSON.parse('{{ .Results | json }}');

        const severityOrder = { 'Critical': 1, 'High': 2, 'Medium': 3, 'Low': 4, 'Informational': 5, 'None': 6 };

        function getHighestSeverity(vulnerabilities) {
            if (!vulnerabilities || vulnerabilities.length === 0) return 'None';
            return vulnerabilities.reduce((max, v) => severityOrder[v.Severity] < severityOrder[max] ? v.Severity : max, 'None');
        }

        const heatmapGrid = document.getElementById('heatmap-grid');
        const attackPathList = document.getElementById('attack-path-list');
        const detailsContent = document.getElementById('details-content');

        // 1. Process and sort data
        const processedResults = results.map(function(r) {
            r.highestSeverity = getHighestSeverity(r.Vulnerabilities);
            return r;
        });
        processedResults.sort(function(a, b) {
            return severityOrder[a.highestSeverity] - severityOrder[b.highestSeverity];
        });

        // 2. Populate Panels
        processedResults.forEach(result => {
            // Populate Heatmap
            const heatCard = document.createElement('div');
            heatCard.className = `heat-card severity-${result.highestSeverity}`;
            heatCard.textContent = result.URL.split('/').pop() || result.URL; // Show last part of URL
            heatCard.onclick = () => showDetails(result);
            heatmapGrid.appendChild(heatCard);

            // Populate Attack Path (only if vulnerabilities exist)
            if (result.Vulnerabilities && result.Vulnerabilities.length > 0) {
                const attackStep = document.createElement('div');
                attackStep.className = `attack-step severity-${result.highestSeverity}`;
                attackStep.innerHTML = `<strong>${result.highestSeverity}:</strong> ${result.Vulnerabilities[0].Name}`;
                attackStep.onclick = () => showDetails(result);
                attackPathList.appendChild(attackStep);
            }
        });

        // 3. Details Function
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function showDetails(result) {
            let vulnerabilitiesHTML = '<h4>No vulnerabilities detected.</h4>';
            if (result.Vulnerabilities && result.Vulnerabilities.length > 0) {
                vulnerabilitiesHTML = result.Vulnerabilities.map(v => {
                    let mitreHTML = '';
                    if (v.MITRETechniqueID) {
                        mitreHTML = `
                            <div class="mitre-block">
                                <strong>MITRE ATT&CK Technique:</strong>
                                <p><a href="${v.MITRETechniqueURL}" target="_blank">${v.MITRETechniqueID}: ${v.MITRETechniqueName}</a></p>
                            </div>
                        `;
                    }

                    let attackFlowHTML = '';
                    if (v.AttackFlow && v.AttackFlow.length > 0) {
                        attackFlowHTML = `
                            <h5>Guided Attack Flow</h5>
                            <div class="attack-flow-steps">
                                ${v.AttackFlow.map((step, index) => `
                                    <div class="attack-flow-step">
                                        <input type="checkbox" id="step-${result.URL}-${v.Name}-${index}" onchange="saveProgress(this)">
                                        <label for="step-${result.URL}-${v.Name}-${index}">
                                            <strong>${escapeHtml(step.Stage)}:</strong>
                                            <pre><code>${escapeHtml(step.Command)}</code></pre>
                                        </label>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }

                    return `
                        <div class="detail-block">
                            <h4>${v.Name} (${v.Severity})</h4>
                            <p><strong>Description:</strong> ${escapeHtml(v.Description)}</p>
                            <p><strong>Recommendation:</strong> ${escapeHtml(v.Recommendation)}</p>
                            ${attackFlowHTML}
                            ${mitreHTML}
                        </div>
                    `;
                }).join('');
            }

            detailsContent.innerHTML = `
                <h3>${result.URL}</h3>
                <div class="detail-block">
                    <p><strong>Status Code:</strong> ${result.StatusCode}</p>
                    <p><strong>Content-Length:</strong> ${result.ContentLength} bytes</p>
                </div>
                ${vulnerabilitiesHTML}
            `;
            loadProgress();
        }

        function saveProgress(checkbox) {
            localStorage.setItem(checkbox.id, checkbox.checked);
        }

        function loadProgress() {
            document.querySelectorAll('.attack-flow-step input[type="checkbox"]').forEach(checkbox => {
                const savedState = localStorage.getItem(checkbox.id);
                if (savedState !== null) {
                    checkbox.checked = (savedState === 'true');
                }
            });
        }

        // C2 Panel Logic
        const c2TableBody = document.querySelector('#c2-agents-table tbody');
        let selectedAgentId = null;

        async function fetchAgents() {
            try {
                const response = await fetch('/api/agents');
                if (!response.ok) return;
                const agents = await response.json();
                updateAgentsTable(agents);
            } catch (e) {
                console.error("Error fetching agents:", e);
            }
        }

        function updateAgentsTable(agents) {
            c2TableBody.innerHTML = '';
            for (const id in agents) {
                const agent = agents[id];
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.onclick = () => openTerminal(agent);
                row.innerHTML = `
                    <td style="padding: 8px;">${agent.id}</td>
                    <td style="padding: 8px;">${agent.ip_address}</td>
                    <td style="padding: 8px;">${agent.hostname}</td>
                    <td style="padding: 8px;">${agent.os}</td>
                    <td style="padding: 8px;">${new Date(agent.last_seen).toLocaleString()}</td>
                    <td style="padding: 8px;">${agent.status}</td>
                `;
                c2TableBody.appendChild(row);
            }
        }

        function openTerminal(agent) {
            selectedAgentId = agent.id;
            document.getElementById('terminal-title').innerText = `Terminal for Agent: ${agent.id}`;
            document.getElementById('terminal-output').innerHTML = ''; // Clear previous output
            document.getElementById('c2-terminal-modal').style.display = 'block';
            document.getElementById('terminal-input').focus();
        }

        function closeTerminal() {
            document.getElementById('c2-terminal-modal').style.display = 'none';
            selectedAgentId = null;
        }

        document.getElementById('terminal-input').addEventListener('keypress', async function(e) {
            if (e.key === 'Enter' && selectedAgentId) {
                const command = e.target.value;
                e.target.value = '';
                const outputDiv = document.getElementById('terminal-output');
                outputDiv.innerHTML += `> ${escapeHtml(command)}\n`;

                try {
                    const response = await fetch(`/api/agents/${selectedAgentId}/tasks`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ command: command })
                    });
                    if (!response.ok) {
                        outputDiv.innerHTML += `Error sending command.\n`;
                    }
                    // The result will be fetched by the agent and logged on the server side.
                    // A more advanced version would fetch results here.
                } catch (e) {
                    outputDiv.innerHTML += `Error: ${e.toString()}\n`;
                }
            }
        });

        setInterval(fetchAgents, 5000); // Fetch agents every 5 seconds
        fetchAgents(); // Initial fetch

        // 4. Post-Exploitation Panel Logic
        let hasHighOrCriticalVuln = false;
        for (let i = 0; i < processedResults.length; i++) {
            if (processedResults[i].highestSeverity === 'Critical' || processedResults[i].highestSeverity === 'High') {
                hasHighOrCriticalVuln = true;
                break;
            }
        }

        if (hasHighOrCriticalVuln) {
            const postExploitationPanel = document.getElementById('post-exploitation-panel');
            if(postExploitationPanel) {
                postExploitationPanel.style.display = 'block';
            }
        }

    </script>
</body>
</html>
